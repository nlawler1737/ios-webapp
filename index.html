<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web App Creator</title>
        <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="theme-color" content="rgb(50, 50, 50)" />
        <meta
            name="viewport"
            content="width=320, initial-scale=1,user-scaleable=no"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <link id="apple-icon" rel="apple-touch-icon" sizes="180x180" href="" />
        <style>
            * {
                font-family: Arial, Helvetica, sans-serif;
            }
            body {
                margin: 0;
            }
            main {
                background-color: #ffffff57;
                width: max-content;
                padding: 10px;
                display: none;
            }
        </style>
    </head>
    <body>
        <main>
            <strong
                >Workaround For iOS Removal of "data:text/html" Web Apps</strong
            >
            <ul>
                <li>Enter base64 of HTML</li>
                <li>Select background color of your app</li>
                <li>Push "Save"</li>
            </ul>
            <p>
                Once saved, add this page to your home screen. Everything will
                take effect once it is a web app
            </p>
            <br />
            <div>
                <label for="base64-content">Base64 HTML</label>
                <input
                    id="base64-content"
                    type="text"
                    placeholder="base64"
                    name="base64-content"
                />
            </div>
            <div>
                <label for="color-input">Background</label>
                <input type="color" id="color-input" name="color-input" />
            </div>
            <div>
                <label for="color-input">App Icon</label>
                <div>
                    <input
                        type="file"
                        name="appIcon-input"
                        id="appIcon-input"
                    />
                    <br />or
                    <br />
                    <input
                        type="url"
                        name=""
                        id="appIcon-url"
                        placeholder="Image URL"
                    />
                </div>
                <br />
                <img id="appIcon" width="150" src="" alt="App Icon..." />
            </div>
            <button id="redirect-btn">Save</button>
        </main>
        <script>
            const saveBtn = document.querySelector("#redirect-btn");
            const base64Input = document.querySelector("#base64-content");
            const colorInput = document.querySelector("#color-input");
            const appIconUrl = document.querySelector("#appIcon-url");
            const appIconFile = document.querySelector("#appIcon-input");
            const appIconImg = document.querySelector("#appIcon");
            const appleIconMeta = document.querySelector("#apple-icon");

            class Params {
                #params;
                #split_entry = "~.~";
                #split_keyvalue = "~-~";
                constructor(hash) {
                    this.#params = hash
                        ? hash
                              .replace(/^#/, "")
                              .split(this.#split_entry)
                              .map((a) => a.split(this.#split_keyvalue))
                              .reduce((a, b) => {
                                  a[b[0]] = decodeURIComponent(b[1]);
                                  return a;
                              }, {})
                        : {};
                    return this;
                }
                set(key, value) {
                    this.#params[key] = value;
                    window.location.hash = this.hash;
                    return;
                }
                get(key) {
                    return this.#params[key];
                }
                get object() {
                    return { ...this.#params };
                }
                get hash() {
                    return (
                        "#" +
                        Object.entries(this.#params)
                            .map((a) => {
                                a[1] = encodeURIComponent(a[1]);
                                return a.join(this.#split_keyvalue);
                            })
                            .join(this.#split_entry)
                    );
                }
            }

            const params = new Params(window.location.hash);

            displayInformation();

            if (
                "standalone" in window.navigator &&
                window.navigator.standalone
            ) {
                const base64 = atob(params.get("base64"));
                window.onload = function () {
                    document.open();
                    document.write(base64);
                    document.close();
                };
            } else {
                document.querySelector("main").style.display = "block";
            }

            base64Input.addEventListener("change", function () {
                params.set("base64", base64Input.value);
            });

            colorInput.addEventListener("change", function () {
                params.set("background", colorInput.value);
                update_background(colorInput.value);
            });

            appIconUrl.addEventListener(
                "change",
                function (e) {
                    params.set("icon", appIconUrl.value);
                    update_icon(appIconUrl.value);
                },
                false
            );

            appIconFile.addEventListener("change", handleFileSelect, false);

            saveBtn.onclick = function (btn) {
                if (!base64Input.value) return;
                displayInformation();
                update_url();
            };

            function displayInformation() {
                const base64 = params.get("base64");
                const background = params.get("background");
                const icon = params.get("icon");

                update_base64(base64);

                update_background(background);

                update_icon(icon);
            }

            function update_background(background) {
                const color = colorInput.value;

                colorInput.value = background || color;
                document.body.style.background = background || color;
                document
                    .querySelector("[name='theme-color']")
                    .setAttribute("content", background || color);
            }

            function update_url() {
                window.location.hash = params.hash;
            }

            function update_icon(icon) {
                appIconImg.src = icon;
                appleIconMeta.href = icon;
                appIconUrl.value = icon?.match(/^https?/) ? icon : "";
            }

            function update_base64(base64) {
                base64Input.value = base64 || "";
            }

            function handleFileSelect(event) {
                const selectedFile = event.target.files[0];

                if (selectedFile) {
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        const img = new Image();
                        const src = event.target.result;

                        img.src = src;
                        img.onload = function () {
                            const { width, height } = img;
                            if (width > 200 || height > 200) {
                                alert(
                                    "Image must be 200x200 pixels or less. Or use a URL"
                                );
                                return;
                            }
                            params.set("icon", src);
                            update_icon(src);
                        };
                    };

                    reader.readAsDataURL(selectedFile);
                }
            }
        </script>
    </body>
</html>
